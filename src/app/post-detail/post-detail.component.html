<div class="fb-container" *ngIf="post; else loading">

  <div class="media-section">
    <button class="close-btn" routerLink="/">✕</button>
    <div class="media-wrapper">
      <img *ngIf="post.imageUrl" [src]="post.imageUrl" class="main-image">
      <div *ngIf="!post.imageUrl" class="text-only-display">
        {{ post.content }}
      </div>
    </div>
  </div>

  <div class="interaction-section">

    <div class="post-header">
      <img *ngIf="post.avatarUrl" [src]="post.avatarUrl" class="avatar" alt="Avatar">
      <div *ngIf="!post.avatarUrl" class="avatar-placeholder">
        {{ (post.fullName || post.username)?.charAt(0)?.toUpperCase() }}
      </div>
      <div class="user-info">
        <span class="username">{{ post.fullName || post.username }}</span>
        <span class="timestamp">{{ post.createdAt | date:'medium' }}</span>
      </div>
    </div>

    <div class="post-body-scroll">
      <div class="caption" *ngIf="post.imageUrl">
        {{ post.content }}
      </div>
      <hr class="divider">

      <div class="comments-list">
        <div *ngFor="let c1 of comments" class="comment-tree-node">
          <ng-container *ngTemplateOutlet="commentTemplate; context: { $implicit: c1, level: 1 }"></ng-container>

          <div class="replies-container level-2" *ngIf="c1.children?.length > 0">
            <div *ngFor="let c2 of c1.children">
              <ng-container *ngTemplateOutlet="commentTemplate; context: { $implicit: c2, level: 2 }"></ng-container>

              <div class="replies-container level-3" *ngIf="c2.children?.length > 0">
                <ng-container *ngTemplateOutlet="recursiveReplies; context: { list: c2.children }"></ng-container>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="comments.length === 0" class="no-comments">
          Chưa có bình luận nào. Hãy là người đầu tiên!
        </div>
      </div>
    </div>

    <div class="post-footer">
      <div class="stats">
        <span class="like-stat">❤️ {{ post.likeCount }}</span>
        <span class="cmt-stat">{{ post.commentCount }} bình luận</span>
      </div>

      <div class="action-buttons">
        <button [class.active-like]="post.likedByCurrentUser" (click)="toggleLike()">
          <i class="fa fa-thumbs-up"></i> Thích
        </button>
        <button><i class="fa fa-comment"></i> Bình luận</button>
        <button><i class="fa fa-share"></i> Chia sẻ</button>
      </div>

      <div class="input-area">
        <img *ngIf="myAvatarUrl" [src]="myAvatarUrl" class="avatar-small">
        <div *ngIf="!myAvatarUrl" class="avatar-placeholder avatar-small">
          {{ (myFullName || myUsername)?.charAt(0)?.toUpperCase() }}
        </div>
        <div class="input-wrapper">
          <input type="text" placeholder="Viết bình luận..." [(ngModel)]="newCommentContent"
            (keyup.enter)="sendComment()">
          <button (click)="sendComment()" [disabled]="!newCommentContent.trim()">➤</button>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #recursiveReplies let-list="list">
  <div *ngFor="let item of list">
    <ng-container *ngTemplateOutlet="commentTemplate; context: { $implicit: item, level: 3 }"></ng-container>
    <div *ngIf="item.children?.length > 0">
      <ng-container *ngTemplateOutlet="recursiveReplies; context: { list: item.children }"></ng-container>
    </div>
  </div>
</ng-template>

<ng-template #commentTemplate let-comment let-level="level">
  <div class="comment-item">
    <img *ngIf="comment.avatarUrl" [src]="comment.avatarUrl" class="cmt-avatar">
    <div *ngIf="!comment.avatarUrl" class="avatar-placeholder cmt-avatar-placeholder">
      {{ (comment.fullName || comment.username)?.charAt(0)?.toUpperCase() }}
    </div>

    <div class="cmt-content">
      <div class="cmt-bubble">
        <strong>{{ comment.fullName || comment.username || 'User ' + comment.userId }}</strong>
        <span>{{ comment.content }}</span>
      </div>

      <div class="cmt-actions">
        <span>Thích</span> ·
        <span class="action-link" (click)="initReply(comment)">Phản hồi</span> ·
        <span class="time">{{ comment.createdAt | date:'shortTime' }}</span>

        <span *ngIf="comment.userId === myId" class="delete-link" (click)="deleteComment(comment.id)">Xóa</span>
      </div>

      <div *ngIf="activeReplyCommentId === comment.id" class="reply-input-box" [class.reply-level-3]="level >= 3">
        <img *ngIf="myAvatarUrl" [src]="myAvatarUrl" class="reply-avatar-img">
        <div *ngIf="!myAvatarUrl" class="avatar-placeholder reply-avatar-placeholder">
          {{ (myFullName || myUsername)?.charAt(0)?.toUpperCase() }}
        </div>

        <div class="reply-input-wrapper">
          <input [(ngModel)]="replyContent" class="reply-input" placeholder="Viết phản hồi..."
            (keyup.enter)="submitReply(comment.id)" autofocus>
          <div class="reply-actions-row">
            <button class="btn-cancel" (click)="cancelReply()">Hủy</button>
            <button class="btn-submit" (click)="submitReply(comment.id)">Gửi</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #loading>
  <div class="loading-screen">Đang tải bài viết...</div>
</ng-template>